---
title: Event Routing
icon: Shuffle
---

AgeDigitalTwins supports real-time event routing to various external systems when digital twins, relationships, models are created, updated, or deleted, and when telemetry data is published. This enables you to build reactive systems, data pipelines, and analytics solutions.

## Overview

Event routing in AgeDigitalTwins works similarly to Azure Digital Twins, with the following key features:

- **Real-time streaming**: Events are captured and routed in near real-time.
- **CloudEvents format**: All events conform to the [CloudEvents specification](https://cloudevents.io/).
- **Multiple sinks**: Route events to Kafka, Azure Data Explorer (Kusto), MQTT, and Webhooks.
- **Event filtering**: Configure which events are routed to which sinks.
- **Dual event types**: Lifecycle events (durable) and telemetry events (real-time).

## Configuration

You can configure event routing based on your deployment model: **Hosted (Konnektr Cloud)** or **Self-Hosted**.

### Hosted (Konnektr Cloud / Ktrlplane)

If you are using the managed service via **ktrlplane**, you can set up event routing directly in the UI.

#### 1. Define Event Sinks
Navigate to the **Settings** tab of your Digital Twin instance. Here you can add and allow-list event destinations.

{/* ![Event Sinks Configuration in Settings](...placeholder... "Screenshot of ktrlplane Settings tab showing 'Event Sinks' section with Add Sink button") */}

Supported sink types:
- **Kafka / Event Hubs**: Requires broker list and optional SASL/OAuth credentials.
- **Azure Data Explorer (Kusto)**: Requires ingestion URI and database name.
- **MQTT**: Requires broker address, port, and credentials.
- **Webhook**: Requires endpoint URL and authentication (Basic, Bearer, API Key, or OAuth).

#### 2. Configure Event Routes
Once sinks are defined, switch to the **Event Routes** tab to define acts rules that determine which events flow to which sink.

{/* ![Event Routes Configuration](...placeholder... "Screenshot of ktrlplane Event Routes tab showing a list of routes mapping Event Types to Sinks") */}

You can filter by event type (e.g., `TwinCreate`, `Telemetry`) and select the destination sink.

### Self-Hosted (Kubernetes / Helm)

For self-hosted installations running on Kubernetes, you configure event sinks and routes via your Helm chart `values.yaml` or `appsettings.json`.

#### Helm Configuration Example

Here is an example `values.yaml` configuration for setting up Kafka and Kusto sinks, along with routes:

```yaml
config:
  # Event sinks configuration
  eventSinks:
    kafka:
      - name: KafkaSink1
        brokerList: "my-kafka-broker:9092"
        topic: "adt-events"
        saslMechanism: "PLAIN"  # or OAUTHBEARER
        # saslUsername: "user" - (Better to use secrets, see below)
    kusto:
      - name: AdxSink1
        ingestionUri: "https://ingest-mycluster.region.kusto.windows.net"
        database: "MyDatabase"
    mqtt: []
    webhook: 
      - name: WebhookSink1
        url: "https://api.myapp.com/events"
        authenticationType: "Basic"

  # Event routes configuration
  eventRoutes:
    - sinkName: KafkaSink1
      eventFormat: EventNotification  # Lifecycle events
    - sinkName: KafkaSink1
      eventFormat: DataHistory        # Telemetry
    - sinkName: AdxSink1
      eventFormat: DataHistory        # Archive telemetry to Kusto

# Securely inject secrets via extraEnv
extraEnv:
  - name: EventSinks__Kafka__0__SaslPassword
    valueFrom:
      secretKeyRef:
        name: kafka-sasl-password-secret
        key: password
  - name: EventSinks__Webhook__0__Password
    valueFrom:
      secretKeyRef:
        name: webhook-secrets
        key: password
```

## Security & Authentication

AgeDigitalTwins supports multiple authentication mechanisms for sinks:

- **OAuth 2.0 (Generic)**: Configure `TokenEndpoint`, `ClientId`, `ClientSecret`, and `Scope` to use Client Credentials flow with any OIDC provider (Keycloak, Auth0, Azure AD).
- **Azure Identity**: Native support for `DefaultAzureCredential` (Managed Identity / Workload Identity) for Azure services.
- **Basic/API Key**: For simple Webhook or MQTT authentication.

### Federated Authentication (Azure)

For Azure resources (Event Hubs, Kusto), we strongly recommend using Workload Identity Federation instead of secrets. This allows AgeDigitalTwins to authenticate as a service principal without managing passwords.

---

## Event Architecture

The event system uses a dual approach for optimal performance:

<Mermaid chart="
flowchart TD;
A[Property and Lifecycle Events<br/>Logical Replication];
B[Shared Event Queue];
C[Telemetry Events<br/>NOTIFY/LISTEN];
D[Event Consumer<br/>Batch Process];
F[Kafka];
G[Kusto];
H[MQTT];
I[Webhook];
A --> B;
C --> B;
B --> D;
D --> F;
D --> G;
D --> H;
D --> I;" />

- **Lifecycle events**: Durable, captured via logical replication.
- **Telemetry events**: Real-time, captured via PostgreSQL NOTIFY.

## CloudEvents Format

All events follow the **CloudEvents 1.0** specification.

| Attribute | Description |
|-----------|-------------|
| `type` | e.g. `Konnektr.DigitalTwins.Twin.Create` |
| `source` | URI of the instance |
| `subject` | ID of the Twin/Relationship |
| `data` | JSON payload |

For detailed payloads, see [Telemetry Events](/concepts/telemetry) and [API Reference](/reference/api-reference).
